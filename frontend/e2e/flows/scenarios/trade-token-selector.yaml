appId: com.nicolasmartin.dankfolio
env:
    jupSymbol: "jup"
    solSymbol: "sol"
    dankSymbol: "dank"
    usdcSymbol: "usdc"
---
- runFlow: ../common/app-setup.yaml

# Navigate to trade screen via trending coin
- tapOn:
      id: "trending-coin-item-${jupSymbol}"
- tapOn:
      id: "trade-button-${jupSymbol}"

# Test 1: First test token selector interaction without keyboard interference
# Test changing TO token to DANK before entering any amounts
- assertVisible:
      id: "to-token-selector"
- tapOn:
      id: "to-token-selector"
- waitForAnimationToEnd:
      timeout: 3000
# Assert modal is open
- assertVisible:
      id: "token-search-input"
- tapOn:
      id: "search-result-${dankSymbol}"
- waitForAnimationToEnd

# Test 2: Now enter amount with SOL -> DANK setup
# SOL price: $98.45, so 0.1 SOL = $9.84
- tapOn:
      id: "from-token-selector-amount-input"
- inputText: "0.1"
- waitForAnimationToEnd
- hideKeyboard

- runFlow:
      file: ../components/trade-token-selector.yaml
      env:
          FROM_SYMBOL: ${solSymbol}
          FROM_AMOUNT: "0.1"
          FROM_BALANCE: "2.5"
          FROM_USD_VALUE: "9.84"
          TO_SYMBOL: ${dankSymbol}
          TO_AMOUNT: "233232.73"
          TO_BALANCE: "5,000,000"

# Test 3: Change amount and validate
# SOL price: $98.45, so 1 SOL = $98.45
- tapOn:
      id: "from-token-selector-amount-input"
- eraseText
- inputText: "1"
- hideKeyboard
- waitForAnimationToEnd

- runFlow:
      file: ../components/trade-token-selector.yaml
      env:
          FROM_SYMBOL: ${solSymbol}
          FROM_AMOUNT: "1"
          FROM_BALANCE: "2.50"
          FROM_USD_VALUE: "98.45"
          TO_SYMBOL: ${dankSymbol}
          TO_AMOUNT: "23332327.38"
          TO_BALANCE: "5,000,000"

# HACK: SAD
- tapOn:
      id: "swap-coins-button"
- tapOn:
      point: "50%,48%"

# DANK price: $0.000042, so 2344047 DANK â‰ˆ $98.45
- runFlow:
      file: ../components/trade-token-selector.yaml
      env:
          FROM_SYMBOL: ${dankSymbol}
          FROM_AMOUNT: "23332327.38"
          FROM_BALANCE: "5,000,000"
          FROM_USD_VALUE: "97.95"
          TO_SYMBOL: ${solSymbol}
          TO_AMOUNT: "1"
          TO_BALANCE: "2.5"

# Test 4: Change FROM token to USDC and validate with amounts
# Ensure keyboard is hidden before opening modal
- hideKeyboard
- tapOn:
      id: "from-token-selector"
# Wait for modal to open
- waitForAnimationToEnd:
      timeout: 3000
# Assert that the token search modal is visible before interacting with it
- assertVisible:
      id: "token-search-input"
- tapOn:
      id: "search-result-${usdcSymbol}"

# Clear and enter new amount
# USDC price: $1.0, so 100 USDC = $100.00
- tapOn:
      id: "from-token-selector-amount-input"
- eraseText
- inputText: "100"
- hideKeyboard
- waitForAnimationToEnd

- runFlow:
      file: ../components/trade-token-selector.yaml
      env:
          FROM_SYMBOL: ${usdcSymbol}
          FROM_AMOUNT: "100"
          FROM_BALANCE: "1,000"
          FROM_USD_VALUE: "100.00"
          TO_SYMBOL: ${solSymbol}
          TO_AMOUNT: "1.01"
          TO_BALANCE: "2.5"

- tapOn:
      id: "amount-percentage-text-50"
- waitForAnimationToEnd

- runFlow:
      file: ../components/trade-token-selector.yaml
      env:
          FROM_SYMBOL: ${usdcSymbol}
          FROM_AMOUNT: "500"
          FROM_BALANCE: "1,000"
          FROM_USD_VALUE: "500.00"
          TO_SYMBOL: ${solSymbol}
          TO_AMOUNT: "5.05"
          TO_BALANCE: "2.5"

# Ensure keyboard is hidden before opening modal
- hideKeyboard
- tapOn:
      id: "from-token-selector"
- waitForAnimationToEnd:
      timeout: 3000
- assertVisible:
      id: "token-search-input"
- tapOn:
      id: "search-result-${dankSymbol}"
- tapOn:
      id: "amount-percentage-text-50"

- waitForAnimationToEnd
- runFlow:
      file: ../components/trade-token-selector.yaml
      env:
          FROM_SYMBOL: ${dankSymbol}
          FROM_AMOUNT: "2500000"
          FROM_BALANCE: "5,000,000"
          FROM_USD_VALUE: "105"
          TO_SYMBOL: ${solSymbol}
          TO_AMOUNT: "1.06"
          TO_BALANCE: "2.5"

# swap to usd value
- tapOn:
      id: "from-token-selector-swap-button"
- tapOn:
      id: "from-token-selector-amount-input"
- eraseText
- inputText: "40"
- hideKeyboard
- waitForAnimationToEnd
- runFlow:
      file: ../components/trade-token-selector.yaml
      env:
          FROM_SYMBOL: ${dankSymbol}
          FROM_AMOUNT: "40"
          FROM_BALANCE: "5,000,000"
          FROM_USD_VALUE: "952,380.95"
          TO_SYMBOL: ${solSymbol}
          TO_AMOUNT: "0.404"
          TO_BALANCE: "2.5"
