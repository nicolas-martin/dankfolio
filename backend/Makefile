.PHONY: run test lint generate-mocks dev clean backend-kill

# Development
dev: clean setup run

setup:
	@echo "ðŸ“ Creating .env file..."
	@cp .env.example .env

clean:
	@echo "ðŸ§¹ Cleaning up..."
	@rm -f .env

run:
	@lsof -ti :8080 | xargs kill -9 2>/dev/null || true
	@set -a && source .env && set +a && go run cmd/api/main.go > server.log 2>&1 &
	@echo "ðŸš€ Starting server on port 8080..."
	@for i in {1..5}; do \
		if curl -s http://localhost:8080/health > /dev/null; then \
			echo "âœ… API is healthy and ready!"; \
			break; \
		fi; \
		if [ $$i -eq 5 ]; then \
			echo "âŒ API failed to start after 5 attempts"; \
			echo "ðŸ“œ Server logs:"; \
			cat server.log; \
			exit 1; \
		fi; \
		echo "â³ Waiting for API to be ready... ($$i/5)"; \
		sleep 1; \
	done

test:
	@echo "ðŸ§ª Running tests..."
	@go test -v -race ./...
	@echo "âœ… Tests completed"

lint:
	@echo "ðŸ” Running linter..."
	@golangci-lint run
	@echo "âœ… Linting completed"

# Code generation
generate-mocks:
	@echo "ðŸ”„ Generating mocks..."
	@mockgen -source=internal/service/interfaces.go -destination=internal/mocks/service_mocks.go
	@echo "âœ… Mocks generated"

# Docker
docker-build:
	@echo "ðŸ—ï¸  Building Docker image..."
	@docker build -t meme-trader-api .
	@echo "âœ… Docker image built"

docker-run:
	@echo "ðŸ³ Starting Docker container..."
	@docker run -p 8080:8080 --env-file .env meme-trader-api

# Testing
test-api: run test-solana-trades test-coins
	@echo "ðŸ§ª Testing API endpoints..."
	@chmod +x scripts/test-api.sh
	@./scripts/test-api.sh

# Solana Trade Testing
test-solana-trades: run
	@echo "ðŸ§ª Testing Solana Trade Service..."
	@chmod +x scripts/test-solana-trades.sh
	@./scripts/test-solana-trades.sh

# Coin Service Testing
test-coins: run
	@echo "ðŸ§ª Testing Coin Service..."
	@chmod +x scripts/test-coins.sh
	@./scripts/test-coins.sh

# Server Management
backend-kill:
	@echo "ðŸ›‘ Stopping backend server..."
	@lsof -ti :8080 | xargs kill -9 2>/dev/null || echo "âœ… No backend server running" 
